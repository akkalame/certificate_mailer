{% extends 'base.html' %}
{% block title %} Emissor de Certificados {% endblock %}

{% block content %}

	<form id="formData" >
	  <div class="mb-3 row">
			<div class="col-7">
				<label for="templateSelect" class="form-label">Modelo</label>
				<select class="form-select" aria-label="Default select example" id="templateSelect">
				  <option selected>Selecione um modelo</option>
				  {% for plantilla in plantillas %}
					  <option value="{{ plantilla['name'] }}">{{ plantilla['name'] }}</option>
				  {% endfor %}
				</select>
		  </div>
		</div>

		<div class="mb-3 form-check form-switch">
			<input class="form-check-input" type="checkbox" role="switch" id="sendEmailCheck" onchange="state_enviar_email(this)">
			<label class="form-check-label" for="sendEmailCheck">Enviar certificados por e-mail</label>
		</div>
		<div class="mb-3" id="emailSection">
			<div class="col-7" id="emailAccountSection">
				<label for="emailAccountSelect" class="form-label">Selecione uma conta SMTP</label>
				<select class="form-select" aria-label="SMTP Email Account" id="emailAccountSelect" onchange="setEmailAccountData()">
					{% for ea in emailAccounts %}
						<option value="{{ ea['email'] }}">{{ ea['email'] }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="mb-3 form-check form-switch">
				<input class="form-check-input" type="checkbox" role="switch" id="useEmailTemplate" onchange="state_use_email_tp(this)">
				<label class="form-check-label" for="useEmailTemplate">Use um modelo de e-mail</label>
			</div>
			<div class="col-7" id="emailDataSection">
				<label for="subjectTxt" class="form-label">Assunto do E-mail</label>
				<input type="text" class="form-control" id="subjectTxt" aria-describedby="spreadCellHelp">

				<label for="bodyTxt" class="form-label bg">Mensagem</label>
				<textarea class="form-control" aria-label="Body Message" id="bodyTxt" ></textarea>
			</div>
			<div class="col-7" id="emailTemplateSection">
				<label for="emailTemplateSelect" class="form-label">Modelo de e-mail</label>
				<select class="form-select" aria-label="Default select example" id="emailTemplateSelect">
				  {% for tp in emailTemplates %}
					  <option value="{{ tp['name'] }}">{{ tp['name'] }}</option>
				  {% endfor %}
				</select>
		  </div>
	  </div>
	  
	</form>

	<div class="mb-3" >
		<button class="btn btn-primary" type="submit" id="btnEnviar">Gerar Certificados</button>
	  
		<button class="btn btn-link" id="btnSelectDir">Abrir localização dos certificados</button>    
	</div>
	
	<div id="responseLbl" style="text-align: center;"></label>

	{% block custom_js %} 
		<script type="text/javascript">
			document.addEventListener("DOMContentLoaded", function() {
				$("#emailTemplateSection").hide()
				$("#btnEnviar").on("click",generar);
				$("#emailSection").hide();
				$("#btnSelectDir").on("click", open_container_folder);


			});

			function generar(){
				let subject = $('#subjectTxt').val();
				let body = $('#bodyTxt').val();
				let sendEmail = document.getElementById('sendEmailCheck').checked ? 1:0;
				let emailAccount = $("#emailAccountSelect").val();
				let useEmailTp = document.getElementById('useEmailTemplate').checked ? 1:0;
				let emailTemplate = $("#emailTemplateSelect").val() || "";

				if (((sendEmail && subject != "") || (sendEmail && useEmailTp) || !sendEmail)){
					let data = {
							subject: subject,
							body: body,
							templatePath: $("#templateSelect").val(),
							sendEmail: sendEmail,
							emailAccount: emailAccount,
							emailTemplate:emailTemplate,
							useEmailTp:useEmailTp
					}
					sendData(data);
				}

			}

			function sendData(data) {
				$.ajax({
					url:"{{ url_for('generate')}}",
				  	type:"POST",
					data: data,
					success: function(response){
						$("#responseLbl").text( response.response);

					},
					error: function(error){
						console.log(error);
					},
				});
				

				
			}
			
			function state_use_email_tp(check) {
				if (check.checked) {
					$("#emailDataSection").hide();
					$("#emailTemplateSection").show();
				}else{
					$("#emailTemplateSection").hide();
					$("#emailDataSection").show();
				}
				
			}

			function state_enviar_email(check) {
				if (check.checked) {
					$("#emailSection").show();
				}else{
					$("#emailSection").hide();
				}
				
			}

			function toggleEmailAccount(){
				if (document.getElementById('sendViaGoogleCheck').checked)
					$("#emailAccountSection").hide();
				else
					$("#emailAccountSection").show();
			}

			function open_container_folder(){
				$.ajax({
					url:"{{ url_for('openContainerFolder')}}",
					type:"GET",
					success: function(response){
					},
					error: function(error){
						console.log(error);
					},
				});
			}

			function upperCase(input) {
				input.value = input.value.toUpperCase();
			}
		  
		</script>
	{% endblock %}
{% endblock %}